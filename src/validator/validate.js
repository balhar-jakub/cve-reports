import Ajv from 'ajv'
import addformats from 'ajv-formats'
import * as fs from 'node:fs/promises';

/**
 * Load schema stored in the repository and verify the content of the CVE file
 * against the schema. 
 * 
 * @param {JSON} cveContent The CVE to be validated.
 * @returns Nothing or list of errors found during the validation. 
 */
const loadSchemaAndValidateCve = async (cveContent) => {
  try {
    let schemaFile = new URL('./schema.json', import.meta.url);
    let schemaContent = await fs.readFile(schemaFile, 'utf-8')
    let schema = JSON.parse(schemaContent);

    const ajv = new Ajv({ allErrors: true })
    addformats(ajv)
    const validate = ajv.compile(schema)
    const isValid = await validate(cveContent)
    if (!isValid) {
      return (validate.errors);
    }
    return;
  } catch (e) {
    throw Error(`The file can't be validated: ${e.message}`);
  }
}

/**
 * Verifies that the fileContent exists and after the validation
 * collects the error mesages if there are any. 
 * 
 * @param {JSON} cveContent The CVE to be validated
 */
const cveStructureValidator = async (cveContent) => {
  const errors = await loadSchemaAndValidateCve(cveContent)
  if (errors) {
    const errorMessages = errors.map((error) => {
      return `At path ${error.instancePath} ${error.message}`;
    });

    const errorMessage = errorMessages.join('\n');
    console.log(errorMessage)

    throw Error(`Invalid\n ${errorMessage}`)
  } else {
    console.log('JSON validated, CVE data is in specified structure and contains all the necessary');
  }
}

export { cveStructureValidator }